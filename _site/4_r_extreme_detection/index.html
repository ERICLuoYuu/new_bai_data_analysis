<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>  Extreme Detection - Data Analysis for Ecologists</title>
<meta name="description" content="This page features several courses on programming and data analysis. The main focus is Python for absolute beginners, aiming to bring you from zero to a data-handling, cool-graph-creating, statistics-with-ease-calculating and good-code-writing Pythonist.">



<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Data Analysis for Ecologists">
<meta property="og:title" content="  Extreme Detection">
<meta property="og:url" content="http://localhost:4000/4_r_extreme_detection/">


  <meta property="og:description" content="This page features several courses on programming and data analysis. The main focus is Python for absolute beginners, aiming to bring you from zero to a data-handling, cool-graph-creating, statistics-with-ease-calculating and good-code-writing Pythonist.">












<link rel="canonical" href="http://localhost:4000/4_r_extreme_detection/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Data Analysis for Ecologists Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>


  
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Data Analysis for Ecologists
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/python_0_landing_page"
                
                
              >Python for Ecologists</a>
            </li><li class="masthead__menu-item">
              <a
                href="/1_r_basics/"
                
                
              >R for Ecologists</a>
            </li><li class="masthead__menu-item">
              <a
                href="/about"
                
                
              >About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      <nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      
      
        <li>
          
            <a href="/1_r_basics/"><span class="nav__sub-title">Basics of R</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/2_r_data_viz/"><span class="nav__sub-title">Data Visualization</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/3_r_interp_gapfil/"><span class="nav__sub-title">Interpolation and Gap Filling</span></a>
          

          
        </li>
      
        <li>
          
            <a href="/4_r_extreme_detection/"><span class="nav__sub-title">Extreme Value Detection</span></a>
          

          
        </li>
      
    
  </ul>
</nav>

    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="  Extreme Detection">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="http://localhost:4000/4_r_extreme_detection/" itemprop="url"><ol>
  <li>Extreme Detection</li>
</ol>
</a>
          </h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>In this exercise we will look at extreme values in meteorological data. First you will learn about different ways to define what is an “extreme” 
value (extreme relative to what?). Afterwards we will work with an example dataset and play around with an existing R-Script to get some hands on experience with the methods.</p>

<h4 id="table-of-contents">Table of Contents</h4>
<ol>
  <li><a href="#1-material">Material</a></li>
  <li><a href="#2-background">Background</a></li>
  <li><a href="#3-methods-and-implementation">Methods and Implementation</a><br />
  3.1. <a href="#31-peak-over-threshold-pot">Peak Over Threshold (POT)</a><br />
  3.2. <a href="#32-block-maxima-method-bm">Block Maxima (BM)</a><br />
  3.3. <a href="#33-moving-average-method-ma">Moving Average (MA)</a></li>
</ol>

<h3 id="1-material">1. Material</h3>
<p>You can download the required material from these sources:<br />
<a href="/assets/r_ex4/Extreme_detection_script.R">R-Script</a><br />
<a href="/assets/r_ex4/Tair_TS_CH-Dav_1997_2018.RData">Required Data</a><br />
<a href="/assets/r_ex4/wmo-td_1500_en.pdf">Literatur</a></p>

<h3 id="2-background">2. Background</h3>
<p>We will look at three different methods to determine extreme events from time series of meteorological data. The main difference between the methods is the way they define the reference, to which we compare a value to describe it as being “extreme” or not.<br />
Pause for a second and think about how you could describe what an extreme value is.</p>

<p>There are several ways to think about extreme values. An extreme value can simply be the highest/lowest value in a finite set of data. Think for example about testing the highest speed that a car reaches on a test drive. Here the absolute peak value would be a reasonable value of interest.</p>

<p>In meteorological time series we are often interested in a range of extreme values. In other words, we are interested in the values in the tails of the distribution of our sample data, which exceed a certain threshold. It is important to consider the distribution of our underlying dataset and the question we actually want to answer.</p>

<p>Our example dataset comprises of air temperature data from 1997 to 2020. If we are interested in the extreme values with respect to this whole time period, we can simply look at the distribution of all the data, determine a threshold and see which datapoints are above the upper or below the lower threshold.</p>

<p>However, we might also be interested in the months with extreme temperatures. Because our distribution includes winter and summer data, extreme temperatures in spring and autumn will probably not be considered in this approach. For these we would have to create data distributions of seasonal, monthly or even daily data to evaluate extreme events on the respective time scale. This will become more obvious when we look at the methods.</p>

<details>
<summary>
Read More: Extreme value return periods
</summary>
Another approach is the evaluation of extreme values and their probabilities based on historical data. Relating these probabilities to the time series of the data produces "return periods", frequencies in which the extreme values are expected to occur. As an example, requirements for buildings often include a resistance to weather extremes with a certain return period. Making up a case, wind turbines would be built that they can withstand windspeeds with a "return level" in a "return period" of 1 in 10.000, meaning the chance that such a windspeed occurs in a year would be 0.01%.
In meteorological data 
</details>

<h3 id="3-methods-and-implementation">3. Methods and Implementation</h3>
<p>Lets now look at three different methods to analyze extreme events in our sample dataset. We will talk about the reasoning and the R implementation of the methods. The first section is a general introduction to the code. We will then go through each method. In the beginning of each chapter you can find the code for the specific method. This way you can always quickly refer to the context.</p>

<p>In the code you have downloaded is a method called “Extreme_detection” which takes the arguments X, timecol, prob and method.</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Extreme_detection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">timecol</span><span class="p">,</span><span class="n">prob</span><span class="p">,</span><span class="n">method</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>
<p>The arguments for this functions are the following:</p>
<ul>
  <li><strong>X</strong> is the series of data which is to analyzed for extremes</li>
  <li><strong>timecol</strong> is the column of data in which the time is stored</li>
  <li><strong>prob</strong> defines the extreme threshold in terms of percentiles of the data given as integers, e.g. 80, 90, 95. E.g. passing in 90 will define everything above a range of values that includes 90% and below a range that includes the lowest 10% as extreme high/low values.
    <details>

<summary>
Read more: What are quantiles?
</summary>

A quantile is a subset of the given data, that contains a certain percentage of the distribution of the data. E.g. in the following figure, everything left of the red line is in the q10 percentile, the lowest 10% of the data. Everything up to the blue line is in the q90, the quantity that comprises of 90% of the data.
![A test image](.\misc\2023\01\05\quantiles.png)
You can paste the following function in your code after you loaded the data and play around with the visualization of the quantiles:
```R
Quantiles = function(x, q_low, q_high){
  x_mean = mean(x)
  x_sd = sd(x)
  y = dnorm(x, T1997_mean, T1997_sd) # This function creates the y-values of the normal distribution given our data, the mean and the standard deviation
  qh = quantile(x,q_high*0.01) # here we calculate the higher quantile threshold
  ql = quantile(x,q_low*0.01) # here we calculate the lower quantile threshold 

  above_qh = TairData$Tair_f[TairData$Tair_f &gt; qh] # filter the datapoints from our set which are above qh
  below_ql = TairData$Tair_f[TairData$Tair_f &lt; ql] # filter the datapoints from our set which are below ql
  print(paste("Percentage of values below q",q_low,": ",sep = ""))
  print(length(above_q90) / length(TairData$Tair_f) * 100)
  print(paste("Percentage of values above q",q_high,": ",sep = ""))
  print(length(below_q10) / length(TairData$Tair_f) * 100)

  plot(x,y)
  lines(c(ql,ql), c(0,1), col="red", lwd=4)
  lines(c(qh,qh), c(0,1), col="blue", lwd=4)
  legend("topleft", legend=c(paste("Q",q_low,sep = ""), paste("Q",q_high,sep = "")), col=c("red","blue"), lty=1, lwd=4)
  }

Quantiles(TairData$Tair_f,10,90)
```
</details>
  </li>
  <li><strong>method</strong> defines which extreme detection will be used
    <ul>
      <li>“POT” for Point Over Threshold</li>
      <li>“BM” for Block Maxima</li>
      <li>“MA” for Moving Average.</li>
    </ul>
  </li>
</ul>

<p>The structure of the method is rather simple. Depending in the given method argument, one of three blocks of code will be executed. The branching is done with if-conditionals:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Extreme_detection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">timecol</span><span class="p">,</span><span class="n">prob</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">)</span><span class="w"> 
</span><span class="p">{</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'POT'</span><span class="p">)</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="n">...RUNS</span><span class="w"> </span><span class="n">POT</span><span class="w"> </span><span class="n">CODE</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'BM'</span><span class="p">)</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="n">...RUNS</span><span class="w"> </span><span class="n">BM</span><span class="w"> </span><span class="n">CODE</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'MA'</span><span class="p">)</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="n">...RUNS</span><span class="w"> </span><span class="n">MA</span><span class="w"> </span><span class="n">CODE</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">method</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'POT'</span><span class="p">,</span><span class="s1">'BM'</span><span class="p">,</span><span class="s1">'MA'</span><span class="p">))</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="s1">'Error: enter the method for extreme detection'</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>If an invalid method is chosen, the last block is executed simply printing an Error-message.</p>

<p>Below the function definition the example dataset is loaded and you are given some example calls to the function:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#1. Examples----------------------</span><span class="w">
</span><span class="n">load</span><span class="p">(</span><span class="s1">'Tair_TS_CH-Dav_1997_2018.RData'</span><span class="p">)</span><span class="w">  </span><span class="c1"># load the timeseries data provided with the script</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">TairData</span><span class="p">)</span><span class="w">

</span><span class="c1">## Extreme at 95th percentile using POT method---</span><span class="w">
</span><span class="n">Tair_extreme_POT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Extreme_detection</span><span class="p">(</span><span class="n">TairData</span><span class="o">$</span><span class="n">Tair_f</span><span class="p">,</span><span class="w"> </span><span class="n">TairData</span><span class="o">$</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="m">95</span><span class="p">,</span><span class="w"> </span><span class="s1">'POT'</span><span class="p">)</span><span class="w">

</span><span class="c1">## Extreme at 95th percentile using BM method---</span><span class="w">
</span><span class="n">Tair_extreme_BM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Extreme_detection</span><span class="p">(</span><span class="n">TairData</span><span class="o">$</span><span class="n">Tair_f</span><span class="p">,</span><span class="w"> </span><span class="n">TairData</span><span class="o">$</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="m">95</span><span class="p">,</span><span class="w"> </span><span class="s1">'BM'</span><span class="p">)</span><span class="w">

</span><span class="c1">## Extreme at 95th percentile using MA method---</span><span class="w">
</span><span class="n">Tair_extreme_MA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Extreme_detection</span><span class="p">(</span><span class="n">TairData</span><span class="o">$</span><span class="n">Tair_f</span><span class="p">,</span><span class="w"> </span><span class="n">TairData</span><span class="o">$</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="m">95</span><span class="p">,</span><span class="w"> </span><span class="s1">'MA'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>Finally, in the very end of the file you find a number of additional functions which will be used in the exercises.</p>
<h4 id="31-peak-over-threshold-pot">3.1 Peak Over Threshold (POT)</h4>

<p>Peak over threshold codeblock:</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'POT'</span><span class="p">)</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="n">sprintf</span><span class="p">(</span><span class="s1">'Extremes detection using peak over threshold method at: %f percentile'</span><span class="p">,</span><span class="n">prob</span><span class="p">)</span><span class="w">
    </span><span class="n">DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timecol</span><span class="p">)</span><span class="w">
    </span><span class="n">DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
      </span><span class="n">mutate</span><span class="p">(</span><span class="n">Extreme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">if_else</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">quantile</span><span class="p">(</span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prob</span><span class="o">*</span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="s1">'Extreme-high'</span><span class="p">,</span><span class="w">
                               </span><span class="n">if_else</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">quantile</span><span class="p">(</span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="w"> </span><span class="n">prob</span><span class="o">*</span><span class="m">0.01</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="s1">'Extreme-low'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Not-Extreme'</span><span class="p">)))</span><span class="w">  </span><span class="c1">## selecting values higher and lower than the percentile</span><span class="w">
    
    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
      </span><span class="n">ggplot</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
      </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Extreme</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
      </span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">DF</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The first approach is the Point Over Threshold (POT) method. We define fixed thresholds for the dataset, defining the upper and lower bounds above or below which values will be considered extreme. The boundaries are defined by the quantiles we provided as an argument to the function.</p>

<p>So what is happening in the code?</p>

<p>Very simple: First we create a new Dataframe with our data and the respective dates.  This dataframe is fed into a pipeline where we “mutate” the dataframe. In the mutation, a new column is added called “Extreme”. This column is then populated through a conditional function, the if_else() function from the dplyr package. Here the code gets a bit complicated, because there is a second if_else() inside the first if_else() function. It is a “nested” function.  It works like this:<br />
Normally the if_else() function checks a condition and for all values passed and returns one of two values, depending on whether the condition is true or false. Consider this:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-5</span><span class="p">,</span><span class="m">-2</span><span class="p">,</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1"># x now is a vector [-5,-2,2]</span><span class="w">
</span><span class="n">if_else</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="s2">"positive"</span><span class="p">,</span><span class="w"> </span><span class="s2">"negative"</span><span class="p">)</span><span class="w"> </span><span class="c1"># Returns "positive" when provided value &gt; 0, else returns "negative"</span><span class="w">
</span><span class="n">Output</span><span class="o">:</span><span class="w">
</span><span class="n">negative</span><span class="w">
</span><span class="n">negative</span><span class="w">
</span><span class="n">positive</span><span class="w">
</span></code></pre></div></div>
<p>So now when we have a nested if_else() function the “inner” function gets executed when the first condition returns false:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-5</span><span class="p">,</span><span class="m">-2</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1"># x now is a vector [-5,-2,0,2]</span><span class="w">
</span><span class="n">if_else</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="s2">"positive"</span><span class="p">,</span><span class="w"> </span><span class="c1"># When the number is bigger than 0, function returns "positive", else second if_else() is executed</span><span class="w">
  </span><span class="n">if_else</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="s2">"null"</span><span class="p">,</span><span class="s2">"negative"</span><span class="p">))</span><span class="w"> </span><span class="c1"># When the number is equal 0 returns "null", else returns "negative"</span><span class="w">
</span><span class="n">Output</span><span class="o">:</span><span class="w">
</span><span class="n">negative</span><span class="w">
</span><span class="n">negative</span><span class="w">
</span><span class="n">null</span><span class="w">
</span><span class="n">positive</span><span class="w">
</span></code></pre></div></div>
<p>In our POT-codeblock we first examine if the datapoint is bigger than the upper quantile threshold. If so, it sets the value in the “Extrem” column to “Extreme-high”. If not, the second if_else block checks whether the value is lower thant the lower quantile boundary. If so, it sets the value of the “Extreme” column to “Extreme-low”, else to “Not-Extreme”.</p>

<p>Go ahead and run the example for the POT method:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Extreme at 95th percentile using POT method---</span><span class="w">
</span><span class="n">Tair_extreme_POT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Extreme_detection</span><span class="p">(</span><span class="n">TairData</span><span class="o">$</span><span class="n">Tair_f</span><span class="p">,</span><span class="w"> </span><span class="n">TairData</span><span class="o">$</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="m">95</span><span class="p">,</span><span class="w"> </span><span class="s1">'POT'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>You will get a plot of the data with marked extreme low and high values (see spoiler below) as well as a dataframe that contains the “Extreme” column along with the original data.</p>

<p>Output Figure:<br />
<img src="/assets/r_ex4/extreme_POT.png" alt="POT image" />
<em>Figure 1: Extreme values based on the whole dataset POT method</em></p>

<p>As expected you can see that this plot gives us information about the extreme values with respect to the whole timeline.</p>

<hr />
<h4 id="exercise">Exercise</h4>

<ol>
  <li>Lets fiddle with the code for a bit. Change the <strong>prob</strong> parameter to 85, 75 and see how the output changes. How many extreme values do you expect when setting prob to 50? Think about it and then run the function with that quantile.</li>
  <li>In the additional methods at the end of the script you can find a function called <code class="language-plaintext highlighter-rouge">Extremes_per_year()</code>. Run it with your output from the POT extreme detection with different quantiles as argument and evaluate the output. What do the trend lines indicate? 
Extra: If you want you can evaluate the trend lines by fiddeling with the function code. Remember the lesson about linear models and the “summary()” method. How would you describe the usefulness of the linear model fitted to this data?</li>
  <li>You can visualize the thresholds that define extreme values using the <code class="language-plaintext highlighter-rouge">Quantiles()</code> function which is given in the additional functions. Run it with the output of your extreme detection function for a few different prob arguments. Note that you have to pass the lower and upper quantiles to the <code class="language-plaintext highlighter-rouge">Quantile()</code> function, e.g. for 95 % you call it as <code class="language-plaintext highlighter-rouge">Quantiles(dataframe, 5, 95)</code>. Look at the different plots, what do you think would be an appropriate threshold?</li>
</ol>

<hr />

<h4 id="32-block-maxima-method-bm">3.2. Block Maxima Method (BM)</h4>
<p>Block maxima codeblock:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'BM'</span><span class="p">)</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="n">sprintf</span><span class="p">(</span><span class="s1">'Extremes detection using block maxima at %f percentile'</span><span class="p">,</span><span class="n">prob</span><span class="p">)</span><span class="w">
    </span><span class="n">DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timecol</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">mutate</span><span class="p">(</span><span class="n">DOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="s1">'%j'</span><span class="p">)))</span><span class="w"> </span><span class="c1"># calculating DOY for long-term mean, calculate month if working on monthly data.</span><span class="w">
    
    </span><span class="n">DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">mutate</span><span class="p">(</span><span class="n">Var_15ma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lead</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="n">zoo</span><span class="o">::</span><span class="n">rollmean</span><span class="p">(</span><span class="n">Value</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'center'</span><span class="p">)),</span><span class="m">7</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">   </span><span class="c1">## 15-day moving average and then long-term mean</span><span class="w">
      </span><span class="n">group_by</span><span class="p">(</span><span class="n">DOY</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
      </span><span class="n">mutate</span><span class="p">(</span><span class="n">Var_LTm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">boot</span><span class="p">(</span><span class="n">Var_15ma</span><span class="p">,</span><span class="n">meanFunc</span><span class="p">,</span><span class="m">100</span><span class="p">)</span><span class="o">$</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w">  </span><span class="o">%&gt;%</span><span class="w">   </span><span class="c1">## Var_LTm is the long-term mean based on a 15-day moving average-</span><span class="w">
      </span><span class="n">mutate</span><span class="p">(</span><span class="n">del_Var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Var_LTm</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">       </span><span class="c1">## deviation from a long-term mean</span><span class="w">
      </span><span class="n">mutate</span><span class="p">(</span><span class="n">Extreme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">if_else</span><span class="p">(</span><span class="n">del_Var</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">quantile</span><span class="p">(</span><span class="n">del_Var</span><span class="p">,</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prob</span><span class="o">*</span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="s1">'Extreme-high'</span><span class="p">,</span><span class="w">
                               </span><span class="n">if_else</span><span class="p">(</span><span class="n">del_Var</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">quantile</span><span class="p">(</span><span class="n">del_Var</span><span class="p">,</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">prob</span><span class="o">*</span><span class="m">0.01</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="s1">'Extreme-low'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Not-Extreme'</span><span class="p">)))</span><span class="w">  </span><span class="c1">## Assigning extreme classes based on del_Var</span><span class="w">
    
    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
      </span><span class="n">ggplot</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
      </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Extreme</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">,</span><span class="w"> </span><span class="n">stroke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">21</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
      </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Value'</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
      </span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Var_LTm</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Long-term mean'</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
      </span><span class="n">scale_color_manual</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'black'</span><span class="p">,</span><span class="s1">'grey50'</span><span class="p">))</span><span class="w">
    
    </span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">
    
    </span><span class="nf">return</span><span class="p">(</span><span class="n">DF</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The next method we are looking at is the “Block Maxima” method. As the name states, we are looking at a certain “block” of data and find the maxima based on the defined threshold of the values in this block. There are several ways we could define these reference blocks. For example we could look at every year individually and find the extreme values for these. We would get an array of the hottest and coldest days of each year separately.
If we where more interested in extreme values across years, we could for example define a block as data from each season across the years. So the block “spring” would consist of data from 01.03. to 31.05. across all the years in the dataset. We could then find extremes based on the quantiles of the seasonally data and separate e.g. extreme values in spring and autumn from the overshadowing extreme values in winter and summer.</p>

<p>In our example code the blocks are defined as the values for each single day across all the years. The procedure is as follows:</p>

<p><strong>Step 1</strong><br />
In the first line we again create a dataframe with the data, a date column and then add a new column called “DOY” with a mutation, that gives each date a value of 1 to 365. We can later use these values to calculate a mean for each year across the seasons:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="n">DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timecol</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">mutate</span><span class="p">(</span><span class="n">DOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="s1">'%j'</span><span class="p">)))</span><span class="w"> </span><span class="c1"># calculating DOY </span><span class="w">
</span></code></pre></div></div>

<p><strong>Step 2</strong><br />
Next a second mutation is being done, which creates the column “Var_15ma”. This is the 15 day moving average around every day. Moving average means that the “window” of data we are calculating the mean from varies. For each data point</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="n">DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">mutate</span><span class="p">(</span><span class="n">Var_15ma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lead</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="n">zoo</span><span class="o">::</span><span class="n">rollmean</span><span class="p">(</span><span class="n">Value</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'center'</span><span class="p">)),</span><span class="m">7</span><span class="p">))</span><span class="w"> </span><span class="c1"># 15-day moving average and then long-term mean </span><span class="w">
</span></code></pre></div></div>
<p>Through this, we accquire a smoothing of the daily temperature values and make the underlying dataset for our daily temperature distribution more broad. The reasoning is the following:<br />
We want to create a representative dataset for daily temperature values across the years. If we use the single day for each year, we have a dataset of 18 datapoints which can easily include heavy outliers. By using a moving average of 15 days we enhance our dataset for each day by a factor of 15 to 270 datapoints, still restricted to a pretty small time window. While it does reduce the impact of individual extremely hot or cold days, it is more likely to representatively capture the state of the atmosphere around the time of interest.</p>

<p><strong>Step 3</strong><br />
The next step creates the column “Var_LTm”. This is the column representing the long-term mean (LTm) for each day of the year:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mutate</span><span class="p">(</span><span class="n">Var_LTm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">boot</span><span class="p">(</span><span class="n">Var_15ma</span><span class="p">,</span><span class="n">meanFunc</span><span class="p">,</span><span class="m">100</span><span class="p">)</span><span class="o">$</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w">  </span><span class="o">%&gt;%</span><span class="w">   </span><span class="c1">## Var_LTm is the long-term mean based on a 15-day moving average-</span><span class="w">
</span></code></pre></div></div>
<p>This is a bit of a nested function call because we use a method called “bootstrapping”. Bootstrapping means that we take several random subsamples from the data we have and calculate the mean for each subsample. Then we can look at the distribution of these means e.g. to find confidence intervals. This allows us to asses how representative our mean value for the whole dateset is. Finally, we can calcualte the mean of the means of the subsamples and use that as our final mean value. The function looks like this:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mean</span><span class="p">(</span><span class="n">boot</span><span class="p">(</span><span class="n">Var_15ma</span><span class="p">,</span><span class="n">meanFunc</span><span class="p">,</span><span class="m">100</span><span class="p">)</span><span class="o">$</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>
<p>The order in which these functions are executed is form the inside out: first the function <code class="language-plaintext highlighter-rouge">boot()</code> is called with the parameters Var_15ma, meanFunc and 100. This means we take 100 subsamples from the column Var_15ma and call the function <code class="language-plaintext highlighter-rouge">meanFunc()</code> on them. This is just a function that calculates the mean of a vector. With the $t after the function call we access the resulting vector of 100 means which is returend from the boot() function. Then we simply calculate the mean from these means and ingore the NA-values with <code class="language-plaintext highlighter-rouge">mean(..., na.rm = TRUE)</code>.</p>

<p><strong>Step 4</strong><br />
Finally we calculate the deviation of each datapoint from the previously derived mean and create a new column called “del_Var”. Now these deviations from the mean are split into quantiles and del_vars which are above or below the threshold are defined as extreme:</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mutate</span><span class="p">(</span><span class="n">del_Var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Var_LTm</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">       </span><span class="c1">## deviation from a long-term mean</span><span class="w">
</span><span class="n">mutate</span><span class="p">(</span><span class="n">Extreme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">if_else</span><span class="p">(</span><span class="n">del_Var</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">quantile</span><span class="p">(</span><span class="n">del_Var</span><span class="p">,</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prob</span><span class="o">*</span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="s1">'Extreme-high'</span><span class="p">,</span><span class="w">
                          </span><span class="n">if_else</span><span class="p">(</span><span class="n">del_Var</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">quantile</span><span class="p">(</span><span class="n">del_Var</span><span class="p">,</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">prob</span><span class="o">*</span><span class="m">0.01</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="s1">'Extreme-low'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Not-Extreme'</span><span class="p">)))</span><span class="w">  </span><span class="c1">## Assigning extreme classes based on del_Var</span><span class="w">
    
</span></code></pre></div></div>
<p>Note: In the POT approach the quantiles where built from the whole dataset itself. Here, the quantiles are built from the array of deviations from the mean! Remember this in the exercise when you evaluate the results.</p>

<hr />
<h3 id="exercises">Exercises</h3>

<ol>
  <li>After using POT and the BM method with daily blocks, which method do you expect to yield more extreme values per year? Think about it and then use the <code class="language-plaintext highlighter-rouge">Extremes_per_year()</code> function to check your hypothesis. You can also print a table of the number of high and low extremes using the given function <code class="language-plaintext highlighter-rouge">Total_Extremes()</code> which also takes a dataframe as an argument.</li>
  <li>The Extreme_Detection() function has one parameter called “rollmean_period” which has a default value of 15. This means that the time window on which the mean for each day is calculated is 15 days, the day + the 7 days before and after. Think about how it might affect the outcomes if you set this value to 1 or to 365. To evaluate, you can use the extra functions given in the end of the script, <code class="language-plaintext highlighter-rouge">Plot_Extremes()</code> and <code class="language-plaintext highlighter-rouge">Quantile()</code>. Remember what the quantiles where built from (so which column you have to pass to the <code class="language-plaintext highlighter-rouge">Quantile()</code> function). You can use the <code class="language-plaintext highlighter-rouge">Plot_Extremes()</code> function to plot the extreme values of a specific year e.g. for 2017 like this:
    <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Plot_Extremes</span><span class="p">(</span><span class="n">Tair_extreme_MA</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">Date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="s1">'2017-01-01'</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s1">'2018-01-01'</span><span class="p">))</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ol>

<hr />

<h4 id="33-moving-average-method-ma">3.3. Moving Average Method (MA)</h4>
<p>Moving average codeblock:</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'MA'</span><span class="p">)</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="n">sprintf</span><span class="p">(</span><span class="s1">'Extremes detection using "moving average" at %f percentile'</span><span class="p">,</span><span class="n">prob</span><span class="p">)</span><span class="w">
    </span><span class="n">DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timecol</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">mutate</span><span class="p">(</span><span class="n">DOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">format</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span><span class="s1">'%j'</span><span class="p">)))</span><span class="w"> </span><span class="c1"># calculating DOY for the long-term mean, calculate month if working on monthly data.</span><span class="w">
    
    </span><span class="n">DF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
      </span><span class="n">arrange</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">  
      </span><span class="n">mutate</span><span class="p">(</span><span class="n">Var_15ma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lead</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="n">zoo</span><span class="o">::</span><span class="n">rollmean</span><span class="p">(</span><span class="n">Value</span><span class="p">,</span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'center'</span><span class="p">)),</span><span class="m">7</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">   </span><span class="c1">## 15-day moving average </span><span class="w">
      </span><span class="n">mutate</span><span class="p">(</span><span class="n">del_Var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Var_15ma</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">       </span><span class="c1">## deviation from a 15-day moving average (change the days as per requirement)</span><span class="w">
      </span><span class="n">mutate</span><span class="p">(</span><span class="n">Extreme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">if_else</span><span class="p">(</span><span class="n">del_Var</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">quantile</span><span class="p">(</span><span class="n">del_Var</span><span class="p">,</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prob</span><span class="o">*</span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="s1">'Extreme-high'</span><span class="p">,</span><span class="w">
                               </span><span class="n">if_else</span><span class="p">(</span><span class="n">del_Var</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">quantile</span><span class="p">(</span><span class="n">del_Var</span><span class="p">,</span><span class="w"> </span><span class="n">probs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">prob</span><span class="o">*</span><span class="m">0.01</span><span class="p">),</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="s1">'Extreme-low'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Not-Extreme'</span><span class="p">)))</span><span class="w">  </span><span class="c1">## Assigning extreme classes based on del_Var</span><span class="w">
    
    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DF</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
      </span><span class="n">ggplot</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
      </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Extreme</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">,</span><span class="w"> </span><span class="n">stroke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">21</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
      </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Value'</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
      </span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
      </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Var_15ma</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'moving mean'</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
      </span><span class="n">scale_color_manual</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'black'</span><span class="p">,</span><span class="s1">'grey50'</span><span class="p">))</span><span class="w">
    
    </span><span class="n">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">
    
    </span><span class="nf">return</span><span class="p">(</span><span class="n">DF</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The final method we will look at is the moving average method. As the name already states, here the extremes are detected on a more temporally constrained basis, the moving average around each datapoint. Take a look at the code block above for the moving average method. Everything used here was already used in the blocks before, only the deviation from the mean (the “del_var”) is now computed differently.</p>

<hr />

<h3 id="exercises-1">Exercises</h3>

<ol>
  <li>Think about how using a smaller time reference window might affect the extreme value detection. Would you expect extreme values in this approach to be more or less frequent than in the block averaging method? Then run the detection function and save the output in a new variable. Finally use the given evaluation function <code class="language-plaintext highlighter-rouge">Total_Extremes()</code> and pass it the output. Was your guess right?</li>
  <li>You have now run all three methods. In the evaluation functions you have a given function <code class="language-plaintext highlighter-rouge">Plot_All_Extremes()</code>. Call it with your POT, BA and MA outputs as arguments and look at the temperature ranges which where categorized as extreme values. Write up a very short summarization.</li>
  <li>Change the parameter rollmean_period of the extreme detection function with the MA method to 365 and pass that output to the <code class="language-plaintext highlighter-rouge">Plot_All_Extremes()</code> function. How do you explain the output in comparison to the other methods?</li>
</ol>

<hr />

        
      </section>

      <footer class="page__meta">
        
        


        

      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://instagram.com/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 <a href="http://localhost:4000">Data Analysis for Ecologists</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>





  
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  
    <script src="/assets/js/clipboardrougev2.js"></script>
  


  </body>
</html>
